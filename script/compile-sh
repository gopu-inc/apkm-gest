#!/bin/sh
# compile.sh

echo "ğŸ”§ Compilation d'APKM (version simplifiÃ©e)..."

# CrÃ©er les rÃ©pertoires
mkdir -p obj bin

# DÃ©finir les flags
CFLAGS="-m32 -Iinclude -Wall -O2"
LDFLAGS="-m32"
LIBS="-lcurl -lsqlite3 -lssl -lcrypto -lz -lpthread -lrt -ldl -lm -lsodium -lseccomp -lcap-ng -larchive -llz4 -lzstd -lyaml -ljansson -largon2 -ltoml"

# Compiler chaque fichier source (sauf monitoring.c et parallel.c)
for src in src/*.c; do
    # Ignorer les fichiers exclus
    case "$src" in
        *monitoring.c|*parallel.c|*bool.c)
            echo "â­ï¸  IgnorÃ©: $src"
            continue
            ;;
    esac
    
    obj="obj/$(basename ${src%.c}).o"
    echo "ğŸ› ï¸  Compilation: $src -> $obj"
    gcc $CFLAGS -c $src -o $obj
    if [ $? -ne 0 ]; then
        echo "âŒ Erreur de compilation: $src"
        exit 1
    fi
done

# Linker
echo "ğŸ”— Linkage final..."
gcc $LDFLAGS -o bin/apkm obj/*.o $LIBS

if [ $? -eq 0 ]; then
    echo "âœ… Compilation rÃ©ussie !"
    ls -lh bin/apkm
    file bin/apkm
else
    echo "âŒ Ã‰chec du linkage"
    exit 1
fi

echo ""
echo "ğŸ“¦ Pour exÃ©cuter : ./bin/apkm --help"
